# SPIRE Trust Bundle Automation

This document describes the automated trust bundle generation and deployment system for the SPIRE Fargate mock environment.

## Overview

The trust bundle automation solves the circular dependency issue where SPIRE agents need trust bundles to start, but the trust bundle can only be extracted from a running SPIRE server.

## Problem Solved

**Original Issue**: 
- Agents require trust bundles to establish initial trust with SPIRE server
- Trust bundles can only be extracted from running SPIRE server
- This creates a circular dependency during `docker compose up --build`

**Solution**: 
- Automated trust bundle generation before container builds
- Pre-build trust bundle extraction from temporary SPIRE server
- Trust bundle copying during Docker container builds

## Automated Scripts

### 1. `generate-trust-bundle.sh`
Core trust bundle generation script with multiple strategies:

- **Existing Bundle**: Uses valid existing trust bundle if available
- **Running Server**: Extracts from currently running SPIRE server
- **Temporary Server**: Starts temporary SPIRE server to generate fresh bundle

**Usage:**
```bash
./generate-trust-bundle.sh
```

**Features:**
- Automatic cleanup of temporary containers
- Retry logic for server initialization
- Trust bundle validation and verification
- Size and format checks

### 2. `build-with-trust-bundle.sh`
Comprehensive build orchestration script that automates the entire process:

**Usage:**
```bash
# Standard build with trust bundle
./build-with-trust-bundle.sh

# Clean build (removes existing containers and trust bundle)
./build-with-trust-bundle.sh --clean-build

# Build only (don't start services)
./build-with-trust-bundle.sh --no-start

# Show help
./build-with-trust-bundle.sh --help
```

**Process:**
1. Generates fresh trust bundle (if needed)
2. Verifies trust bundle validity
3. Builds all containers with trust bundle
4. Starts services in correct dependency order
5. Waits for service readiness
6. Displays service status and endpoints

## Docker Container Updates

All agent containers now copy the trust bundle during build:

### Agent Configuration
```
trust_bundle_path = "/opt/spire/trust-bundle/trust-bundle.pem"
```

### Dockerfile Changes
```dockerfile
# Create trust bundle directory
RUN mkdir -p /opt/spire/trust-bundle

# Copy trust bundle (generated by build script)
COPY ../trust-bundle/trust-bundle.pem /opt/spire/trust-bundle/trust-bundle.pem
```

## Usage Instructions

### Quick Start
```bash
# Navigate to the fargate-spire-mock directory
cd /Users/chris.keogh/dev/spire/examples/fargate-spire-mock

# Run automated build with trust bundle
./build-with-trust-bundle.sh
```

### Clean Build
```bash
# Force regeneration of trust bundle and clean rebuild
./build-with-trust-bundle.sh --clean-build
```

### Manual Trust Bundle Generation
```bash
# Generate trust bundle only
./generate-trust-bundle.sh

# Then use standard docker-compose
docker-compose up --build
```

## Trust Bundle Verification

The system automatically verifies trust bundles:

- **Size Check**: Minimum 100 bytes
- **Format Check**: Valid PEM certificate format
- **Content Check**: Contains "BEGIN CERTIFICATE" markers
- **Integrity Check**: File completeness

## Service Endpoints

After successful build and startup:

- **Web Application**: http://localhost:8080
- **API Service**: http://localhost:8082  
- **SPIRE Server**: http://localhost:8081
- **ECS Metadata Mock**: http://localhost:8090

## Troubleshooting

### Trust Bundle Issues
```bash
# Check trust bundle status
ls -la trust-bundle/trust-bundle.pem

# View trust bundle content
cat trust-bundle/trust-bundle.pem

# Force regeneration
rm trust-bundle/trust-bundle.pem
./generate-trust-bundle.sh
```

### Container Build Issues
```bash
# Clean build to resolve caching issues
./build-with-trust-bundle.sh --clean-build

# Check Docker build context
docker-compose build --no-cache
```

### Service Startup Issues
```bash
# Check service logs
docker-compose logs -f

# Check individual service
docker-compose logs spire-server
docker-compose logs fargate-app
```

## Files Modified

- `generate-trust-bundle.sh` - Trust bundle generation script
- `build-with-trust-bundle.sh` - Build orchestration script  
- `app-with-agent/Dockerfile` - Added trust bundle copying
- `api-service-with-agent/Dockerfile` - Added trust bundle copying
- `cli-client-with-agent/Dockerfile` - Added trust bundle copying
- `trust-bundle/trust-bundle.pem` - Generated trust bundle

## Migration from Manual Process

### Before (Manual)
```bash
# Start services
docker-compose up -d

# Wait for server
sleep 15

# Extract trust bundle
./extract-trust-bundle.sh

# Update bootstrap certificates manually
# Restart agents
```

### After (Automated)
```bash
# One command does everything
./build-with-trust-bundle.sh
```

## Security Considerations

- Trust bundles are regenerated on clean builds
- Temporary containers are automatically cleaned up
- Trust bundles are validated before use
- No permanent storage of temporary server state

## Performance Notes

- Initial build may take longer due to trust bundle generation
- Subsequent builds reuse existing valid trust bundles
- Clean builds force full regeneration
- Parallel container builds after trust bundle generation

## Integration with CI/CD

The automated scripts are designed for CI/CD integration:

```yaml
# Example CI/CD step
- name: Build SPIRE Environment
  run: |
    cd examples/fargate-spire-mock
    ./build-with-trust-bundle.sh --clean-build
```

## Legacy Compatibility

The system maintains compatibility with existing manual processes:

- `extract-trust-bundle.sh` still works for manual extraction
- Standard `docker-compose` commands work with pre-generated trust bundles
- Agent configurations remain unchanged
